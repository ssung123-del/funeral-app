<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¥ë¡€ë¬¸ì ìƒì„±ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f2f4f6;
            --card: #ffffff;
            --text: #191f28;
            --text-sub: #8b95a1;
            --border: #e5e8eb;
            --red: #e74c3c;
            --green: #27ae60;
            --orange: #f39c12;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 420px;
            background: var(--card);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
            padding: 30px 24px;
            box-sizing: border-box;
        }

        h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin: 0 0 20px 0;
        }

        /* Segment Control */
        .segment-control {
            display: flex;
            background: #f2f4f6;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .segment-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .segment-btn.active {
            color: var(--primary);
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Inputs */
        .input-group {
            margin-bottom: 12px;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
        }

        .input-icon {
            color: var(--text-sub);
            margin-right: 10px;
            font-size: 18px;
            flex-shrink: 0;
        }

        .custom-input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 15px;
            color: var(--text);
            background: transparent;
            padding: 0;
        }

        .custom-input::placeholder {
            color: #c5c8ce;
        }

        /* Grids */
        .row-grid {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .col-7 {
            flex: 7;
        }

        .col-3 {
            flex: 3;
        }

        .datetime-grid {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .date-col {
            flex: 4;
        }

        .time-col {
            flex: 6;
        }

        select.custom-input {
            -webkit-appearance: none;
            background: transparent;
            text-align: center;
        }

        input[type="date"] {
            font-family: 'Pretendard', sans-serif;
            color: var(--text);
            position: relative;
            width: 100%;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }

        /* UI Elements */
        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-sub);
            margin: 0 0 6px 4px;
            display: block;
        }

        .hidden {
            display: none;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 4px;
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* Joint Funeral Card */
        .joint-card {
            background: #f0f7ff;
            border: 1px solid #cce5ff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
            position: relative;
        }

        .joint-header {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .joint-select {
            font-size: 12px;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #cce5ff;
            color: var(--accent);
        }

        .btn-delete {
            background: white;
            border: 1px solid #ffcccc;
            color: var(--red);
            font-size: 11px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .btn-add-secondary {
            width: 100%;
            background: white;
            border: 1px dashed #3498db;
            color: #3498db;
            padding: 14px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-add-secondary:hover {
            background: #f0f7ff;
        }

        .btn-generate {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Result Area Styles */
        .result-container {
            margin-top: 20px;
            display: none;
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        .result-box.highlight {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .result-box.warning {
            background: #fffaf0;
            border-color: #fce8b2;
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .box-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .byte-info {
            font-size: 12px;
            color: var(--text-sub);
        }

        .byte-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
        }

        .byte-badge.sms {
            background: #d1e7dd;
            color: #0f5132;
        }

        .byte-badge.lms {
            background: #fff3cd;
            color: #664d03;
        }

        .result-text {
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
            color: var(--primary);
            word-break: break-all;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .btn-copy {
            width: 100%;
            background: white;
            border: 1px solid var(--border);
            color: var(--primary);
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: background 0.2s;
        }

        .btn-copy:hover {
            background: #f2f4f6;
        }

        .btn-copy.green {
            color: var(--green);
            border-color: #bbf7d0;
        }

        .auto-tag {
            font-size: 11px;
            color: var(--accent);
            margin-left: 4px;
            font-weight: normal;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="app-container">
        <h2>ì¥ë¡€ë¬¸ì ìƒì„±ê¸°</h2>

        <div class="segment-control">
            <button class="segment-btn active" onclick="setMode('district')" id="btn-district">êµêµ¬ì¥</button>
            <button class="segment-btn" onclick="setMode('church')" id="btn-church">êµíšŒì¥</button>
        </div>
        <input type="hidden" id="mode" value="district">

        <div class="input-group">
            <div class="input-wrapper">
                <i class="ri-map-pin-user-line input-icon"></i>
                <input type="text" id="district" class="custom-input" placeholder="êµêµ¬ëª…">
            </div>
        </div>

        <div style="background: #f8f9fa; padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border);">
            <span class="section-label">ì´ë¦„ ë° ì§ë¶„ <span class="auto-tag" id="ko-tag" style="display:none;">* 'æ•…' ìë™ì¶”ê°€</span></span>
            <div class="row-grid">
                <div class="input-wrapper col-7" style="padding: 8px 12px;">
                    <input type="text" id="name1" class="custom-input" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">
                </div>
                <div class="input-wrapper col-3" style="padding: 8px 4px;">
                    <select id="title1" class="custom-input">
                        <option value="">ì§ë¶„</option>
                        <option value="ì„±ë„">ì„±ë„</option>
                        <option value="ì§‘ì‚¬">ì§‘ì‚¬</option>
                        <option value="ì•ˆìˆ˜ì§‘ì‚¬">ì•ˆìˆ˜</option>
                        <option value="ê¶Œì‚¬">ê¶Œì‚¬</option>
                        <option value="ì¥ë¡œ">ì¥ë¡œ</option>
                        <option value="ëª©ì‚¬">ëª©ì‚¬</option>
                    </select>
                </div>
            </div>
            <div class="row-grid">
                <div class="input-wrapper col-7" style="padding: 8px 12px;">
                    <input type="text" id="name2" class="custom-input" placeholder="ë°°ìš°ì (ì—†ìœ¼ë©´ ë¹ˆì¹¸)">
                </div>
                <div class="input-wrapper col-3" style="padding: 8px 4px;">
                    <select id="title2" class="custom-input">
                        <option value="">ì§ë¶„</option>
                        <option value="ì„±ë„">ì„±ë„</option>
                        <option value="ì§‘ì‚¬">ì§‘ì‚¬</option>
                        <option value="ì•ˆìˆ˜ì§‘ì‚¬">ì•ˆìˆ˜</option>
                        <option value="ê¶Œì‚¬">ê¶Œì‚¬</option>
                        <option value="ì¥ë¡œ">ì¥ë¡œ</option>
                    </select>
                </div>
            </div>
            <div class="input-wrapper" id="relation-area" style="margin-top: 8px; padding: 10px;">
                <i class="ri-link-m input-icon"></i>
                <input type="text" id="relation" class="custom-input" placeholder="ê´€ê³„ (ì˜ˆ: ë¶€ì¹œ) * 'ì†Œì²œ' ìë™ì¶”ê°€">
            </div>
        </div>

        <div id="joint-wrapper" class="hidden">
            <div id="joint-container"></div>
            <button id="btn-add-joint" class="btn-add-secondary" onclick="addJointCard()">
                <i class="ri-add-circle-line"></i> ê²¹ì¥ ì¶”ê°€í•˜ê¸°
            </button>
        </div>

        <div id="district-section">
            <div class="toggle-container">
                <span class="toggle-label">ê°œë³„ì¡°ë¬¸ ì§„í–‰</span>
                <label class="switch">
                    <input type="checkbox" id="isIndividual" onchange="toggleIndividual()">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="group-wiro" class="input-group">
                <span class="section-label">ìœ„ë¡œì˜ˆë°°</span>
                <div class="datetime-grid">
                    <div class="input-wrapper date-col"><input type="date" id="date_wiro_district" class="custom-input"></div>
                    <div class="input-wrapper time-col"><input type="text" id="time_wiro_district" class="custom-input" placeholder="ì‹œê°„ (ì˜ˆ: ì˜¤í›„2ì‹œ)"></div>
                </div>
            </div>
            <div id="group-individual" class="input-group hidden">
                <span class="section-label">ë°œì¸ ë‚ ì§œ (ì‹œê°„ ì…ë ¥ ì—†ìŒ)</span>
                <div class="input-wrapper">
                    <i class="ri-calendar-check-line input-icon"></i>
                    <input type="date" id="date_balin" class="custom-input">
                </div>
            </div>
        </div>

        <div id="church-section" class="hidden">
            <span class="section-label" style="color:var(--accent);">ìƒì„¸ ì¼ì • (ì…ë ¥ëœ ê²ƒë§Œ í‘œì‹œ)</span>
            <div class="section-label" style="margin-top:8px;">ìœ„ë¡œì˜ˆë°°</div>
            <div class="datetime-grid">
                <div class="input-wrapper date-col"><input type="date" id="date_wiro_church" class="custom-input"></div>
                <div class="input-wrapper time-col"><input type="text" id="time_wiro_church" class="custom-input" placeholder="ì‹œê°„ (ì˜ˆ: ì˜¤í›„4ì‹œ)"></div>
            </div>
            <div class="section-label">ì…ê´€ì˜ˆë°°</div>
            <div class="datetime-grid">
                <div class="input-wrapper date-col"><input type="date" id="date_ipgwan" class="custom-input"></div>
                <div class="input-wrapper time-col"><input type="text" id="time_ipgwan" class="custom-input" placeholder="ì‹œê°„ (ì˜ˆ: ì˜¤í›„2ì‹œ)"></div>
            </div>
            <div class="section-label">ì²œêµ­í™˜ì†¡(ë°œì¸)</div>
            <div class="datetime-grid">
                <div class="input-wrapper date-col"><input type="date" id="date_sendoff" class="custom-input"></div>
                <div class="input-wrapper time-col"><input type="text" id="time_sendoff" class="custom-input" placeholder="ì‹œê°„ (ì˜ˆ: ì˜¤ì „6ì‹œ)"></div>
            </div>
        </div>

        <div class="input-group" style="margin-top: 15px;">
            <div class="input-wrapper">
                <i class="ri-hospital-line input-icon"></i>
                <input type="text" id="location" class="custom-input" placeholder="ì¥ë¡€ì‹ì¥ (ì˜ˆ: OOë³‘ì›ì¥ë¡€ì‹ì¥Oí˜¸)">
            </div>
        </div>

        <button class="btn-generate" onclick="generate()">ë¬¸ì ìƒì„±í•˜ê¸°</button>

        <div class="result-container" id="resultArea"></div>

        <div id="step2-section" class="hidden" style="margin-top: 30px; border-top: 2px dashed #eee; padding-top: 20px;">
            <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 15px;">êµìš°ì†Œì‹ ìƒì„¸ ì…ë ¥</h3>

            <div class="input-group">
                <span class="section-label">ì œëª© (í—¤ë”)</span>
                <div class="input-wrapper">
                    <input type="text" id="s2_header" class="custom-input" placeholder="[êµêµ¬ì¥-ê°•ë‚¨] ë¥˜ì–‘ì—´ì•ˆìˆ˜ì§‘ì‚¬...">
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 12px; border-radius: 12px; margin-bottom: 15px;">
                <span class="section-label">ìœ„ë¡œì˜ˆë°°</span>
                <div class="datetime-grid">
                    <div class="input-wrapper date-col"><input type="date" id="s2_date_wiro" class="custom-input"></div>
                    <div class="input-wrapper time-col"><input type="text" id="s2_time_wiro" class="custom-input" placeholder="ì˜¤ì „ 10:00"></div>
                </div>
                <div style="text-align: right;">
                    <label style="font-size:13px; color:var(--text); cursor:pointer;">
                        <input type="checkbox" id="s2_chk_wiro" checked> êµíšŒì¶œë°œ
                    </label>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 12px; border-radius: 12px; margin-bottom: 15px;">
                <span class="section-label">ì…ê´€ì˜ˆë°°</span>
                <div class="datetime-grid">
                    <div class="input-wrapper date-col"><input type="date" id="s2_date_ip" class="custom-input"></div>
                    <div class="input-wrapper time-col"><input type="text" id="s2_time_ip" class="custom-input" placeholder="ì˜¤ì „ 10:00"></div>
                </div>
                <div style="text-align: right;">
                    <label style="font-size:13px; color:var(--text); cursor:pointer;">
                        <input type="checkbox" id="s2_chk_ip" checked> êµíšŒì¶œë°œ
                    </label>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 12px; border-radius: 12px; margin-bottom: 15px;">
                <span class="section-label">ë°œì¸ / ì²œêµ­í™˜ì†¡</span>
                <div class="datetime-grid">
                    <div class="input-wrapper date-col"><input type="date" id="s2_date_bal" class="custom-input"></div>
                    <div class="input-wrapper time-col"><input type="text" id="s2_time_bal" class="custom-input" placeholder="ì˜¤ì „ 5:30"></div>
                </div>
                <div style="text-align: right;">
                    <label style="font-size:13px; color:var(--text); cursor:pointer;">
                        <input type="checkbox" id="s2_chk_bal" checked> êµíšŒì¶œë°œ
                    </label>
                </div>
            </div>

            <div class="input-group">
                <span class="section-label">ë¹ˆì†Œ</span>
                <div class="input-wrapper">
                    <input type="text" id="s2_binso" class="custom-input" placeholder="ì¥ë¡€ì‹ì¥">
                </div>
            </div>

            <div class="input-group">
                <span class="section-label">ì¥ì§€</span>
                <div class="input-wrapper">
                    <input type="text" id="s2_jangji" class="custom-input" placeholder="ì¥ì§€ ì…ë ¥">
                </div>
            </div>

            <button class="btn-generate" onclick="generateStep2()" style="background: var(--accent);">êµìš°ì†Œì‹ ìƒì„±í•˜ê¸°</button>
            <div id="step2-result" style="margin-top: 20px; display: none;"></div>
        </div>
    </div>

    <script>
        window.onload = function () {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const today = `${year}-${month}-${day}`;
            document.querySelectorAll('input[type="date"]').forEach(input => input.value = today);
        };

        function clean(text) { return text ? text.replace(/\s+/g, '') : ""; }

        function parseTime(text) {
            if (!text) return { h: 0, m: 0, isAm: false, isPm: false, valid: false };
            const s = text.replace(/\s+/g, '');

            let isAm = s.includes("ì˜¤ì „") || s.toLowerCase().includes("am");
            let isPm = s.includes("ì˜¤í›„") || s.toLowerCase().includes("pm");

            const nums = s.match(/\d+/g);
            if (!nums || nums.length === 0) return { h: 0, m: 0, isAm, isPm, valid: false };

            let h = parseInt(nums[0], 10);
            let m = nums.length > 1 ? parseInt(nums[1], 10) : 0;

            if (!isAm && !isPm) {
                if (h >= 12) {
                    if (h > 12 && h < 24) { h -= 12; isPm = true; }
                    else if (h === 12) { isPm = true; }
                    else if (h === 24) { h = 12; isAm = true; }
                }
            } else {
                if (h > 12) h -= 12;
            }

            return { h, m, isAm: isAm || (!isAm && !isPm && h < 12), isPm, valid: true };
        }

        // *** ìˆ˜ì •ëœ ë¶€ë¶„: ì˜¤ì „/ì˜¤í›„ ë’¤ì˜ ê³µë°± ì œê±° ***
        function formatTime(text, forceMinutes = false) {
            const parsed = parseTime(text);
            if (!parsed.valid) return text || "";

            const { h, m, isPm } = parsed;
            const p = isPm ? "ì˜¤í›„" : "ì˜¤ì „";

            if (m === 0 && !forceMinutes) {
                return `${p}${h}ì‹œ`; // ê³µë°± ì œê±°
            } else {
                return `${p}${h}:${String(m).padStart(2, '0')}`; // ê³µë°± ì œê±°
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return "";
            const [y, m, d] = dateStr.split('-').map(Number);
            const target = new Date(y, m - 1, d);
            const today = new Date();
            target.setHours(0, 0, 0, 0); today.setHours(0, 0, 0, 0);
            const weekDays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return (target.getTime() === today.getTime()) ? `${d}ì¼(ì˜¤ëŠ˜)` : `${d}ì¼(${weekDays[target.getDay()]})`;
        }

        function combineDateTime(dateId, timeId, forceMinutes = false) {
            const timeVal = formatTime(document.getElementById(timeId).value, forceMinutes);
            if (!timeVal) return "";
            return `${formatDate(document.getElementById(dateId).value)}${timeVal}`;
        }

        function getByteLength(s) {
            let b = 0;
            for (let i = 0; i < s.length; i++) {
                const c = s.charCodeAt(i);
                b += (c >> 7) ? 2 : 1;
            }
            return b;
        }

        function buildPersonName(n, t, spouseN, spouseT) {
            if (!n) return "";
            if (!spouseN) return `${n}${t}`;
            if (t === spouseT) return `${n}(${spouseN})${t}`;
            return `${n}${t}(${spouseN}${spouseT})`;
        }

        function setMode(mode) {
            document.getElementById('mode').value = mode;
            const isDistrict = (mode === 'district');
            const isChurch = (mode === 'church');

            document.getElementById('btn-district').classList.toggle('active', isDistrict);
            document.getElementById('btn-church').classList.toggle('active', isChurch);

            document.getElementById('district-section').classList.toggle('hidden', !isDistrict);
            document.getElementById('church-section').classList.toggle('hidden', !isChurch);
            document.getElementById('relation-area').style.display = isDistrict ? 'flex' : 'none';

            document.getElementById('joint-wrapper').classList.toggle('hidden', !isChurch);
            document.getElementById('ko-tag').style.display = isChurch ? 'inline' : 'none';
        }

        function toggleIndividual() {
            const isIndividual = document.getElementById('isIndividual').checked;
            document.getElementById('group-wiro').classList.toggle('hidden', isIndividual);
            document.getElementById('group-individual').classList.toggle('hidden', !isIndividual);
        }

        function addJointCard() {
            const container = document.getElementById('joint-container');
            const count = container.children.length + 1;

            const cardHTML = `
        <div class="joint-card">
            <div class="joint-header">
                <span>ì¶”ê°€ ì¥ë¡€ ${count}</span>
                <div style="display:flex; gap:5px; align-items:center;">
                    <button class="btn-delete" onclick="this.closest('.joint-card').remove()">ì‚­ì œ</button>
                    <select class="joint-select j-type"><option value="êµêµ¬ì¥">êµêµ¬ì¥</option><option value="êµíšŒì¥">êµíšŒì¥</option></select>
                </div>
            </div>
            <div class="input-group"><div class="input-wrapper"><input type="text" class="custom-input j-district" placeholder="ì¶”ê°€ êµêµ¬ëª… (ì˜ˆ: êµêµ¬)"></div></div>
            <div class="row-grid">
                <div class="input-wrapper col-7"><input type="text" class="custom-input j-name" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)"></div>
                <div class="input-wrapper col-3"><select class="custom-input j-title"><option value="">ì§ë¶„</option><option value="ì„±ë„">ì„±ë„</option><option value="ì§‘ì‚¬">ì§‘ì‚¬</option><option value="ì•ˆìˆ˜ì§‘ì‚¬">ì•ˆìˆ˜</option><option value="ê¶Œì‚¬">ê¶Œì‚¬</option><option value="ì¥ë¡œ">ì¥ë¡œ</option></select></div>
            </div>
            <div class="row-grid">
                <div class="input-wrapper col-7"><input type="text" class="custom-input j-spouse" placeholder="ë°°ìš°ì (ë¹ˆì¹¸ ê°€ëŠ¥)"></div>
                <div class="input-wrapper col-3"><select class="custom-input j-spouse-title"><option value="">ì§ë¶„</option><option value="ì„±ë„">ì„±ë„</option><option value="ì§‘ì‚¬">ì§‘ì‚¬</option><option value="ì•ˆìˆ˜ì§‘ì‚¬">ì•ˆìˆ˜</option><option value="ê¶Œì‚¬">ê¶Œì‚¬</option><option value="ì¥ë¡œ">ì¥ë¡œ</option></select></div>
            </div>
            <div class="input-group"><div class="input-wrapper"><input type="text" class="custom-input j-rel" placeholder="ê´€ê³„ (ì˜ˆ: ë¶€ì¹œ)"></div></div>
        </div>`;
            container.insertAdjacentHTML('beforeend', cardHTML);
        }

        function createResultBoxHTML(title, text, bytes, type, id) {
            let badgeClass = (bytes <= 90) ? "sms" : "lms";
            let badgeText = (bytes <= 90) ? "SMS" : "LMS";
            let boxClass = (type === 'opt') ? "result-box highlight" : (type === 'warn' ? "result-box warning" : "result-box");
            let btnClass = (type === 'opt') ? "btn-copy green" : "btn-copy";

            return `
        <div class="${boxClass}">
            <div class="box-header">
                <div class="box-title">${title}</div>
                <div class="byte-info">
                    ${bytes} Byte <span class="byte-badge ${badgeClass}">${badgeText}</span>
                </div>
            </div>
            <div class="result-text" id="text-${id}">${text}</div>
            <button class="${btnClass}" onclick="copyToClipboard('text-${id}')">
                <i class="ri-file-copy-line"></i> ë³µì‚¬í•˜ê¸°
            </button>
        </div>`;
        }

        // *** ìˆ˜ì •ëœ ë¶€ë¶„: ìƒì„± ì‹œ ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±° ***
        function generate() {
            const mode = document.getElementById('mode').value;
            const mainDistrict = clean(document.getElementById('district').value).replace(/êµêµ¬/g, '');
            const location = clean(document.getElementById('location').value);
            const resultArea = document.getElementById('resultArea');
            resultArea.innerHTML = "";

            let mName = clean(document.getElementById('name1').value);
            let mTitle = document.getElementById('title1').value;
            let mSpouse = clean(document.getElementById('name2').value);
            let mSpouseTitle = document.getElementById('title2').value;

            if (!mainDistrict || !mName || !location) {
                alert('í•„ìˆ˜ ì •ë³´(êµêµ¬, ì´ë¦„, ì¥ì†Œ)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            let fullText = "";

            if (mode === 'district') {
                let header = `[êµêµ¬ì¥-${mainDistrict}]`;
                let rel = clean(document.getElementById('relation').value).replace(/ì†Œì²œ/g, '');
                let nameStr = buildPersonName(mName, mTitle, mSpouse, mSpouseTitle);
                let body = `${nameStr}${rel}ì†Œì²œ`; // ë„ì–´ì“°ê¸° ì œê±°

                const isIndividual = document.getElementById('isIndividual').checked;
                if (isIndividual) {
                    let balinDate = document.getElementById('date_balin').value;
                    if (!balinDate) { alert('ë°œì¸ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                    body += `/ê°œë³„ì¡°ë¬¸/ë°œì¸:${formatDate(balinDate)}`;
                } else {
                    let wiro = combineDateTime('date_wiro_district', 'time_wiro_district');
                    if (!wiro) { alert('ìœ„ë¡œì˜ˆë°° ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                    body += `/ìœ„ë¡œ:${wiro}êµíšŒì¶œ`; // ë„ì–´ì“°ê¸° ì œê±°
                }
                fullText = `${header}${body}/${location}`;

            } else {
                let headerText = `êµíšŒì¥-${mainDistrict}`;
                let nameStr = buildPersonName("æ•…" + mName, mTitle, mSpouse, mSpouseTitle);
                let body = `${nameStr}ì†Œì²œ`;

                const cards = document.querySelectorAll('.joint-card');
                cards.forEach(card => {
                    let jType = card.querySelector('.j-type').value;
                    let jDist = clean(card.querySelector('.j-district').value).replace(/êµêµ¬/g, '');
                    let jName = clean(card.querySelector('.j-name').value);
                    let jTitle = card.querySelector('.j-title').value;
                    let jSpouse = clean(card.querySelector('.j-spouse').value);
                    let jSpouseTitle = card.querySelector('.j-spouse-title').value;
                    let jRel = clean(card.querySelector('.j-rel').value);

                    if (jDist && jName) {
                        headerText += `/${jType}-${jDist}`;
                        let jNameStr = buildPersonName(jName, jTitle, jSpouse, jSpouseTitle);
                        body += `/${jNameStr}${jRel}`;
                    }
                });
                let header = `[${headerText}]`;

                const rawTimes = [
                    document.getElementById('time_wiro_church').value,
                    document.getElementById('time_ipgwan').value,
                    document.getElementById('time_sendoff').value
                ];
                const hasMinutes = rawTimes.some(t => {
                    const parsed = parseTime(t);
                    return parsed.valid && parsed.m > 0;
                });

                let wiro = combineDateTime('date_wiro_church', 'time_wiro_church', hasMinutes);
                let ipgwan = combineDateTime('date_ipgwan', 'time_ipgwan', hasMinutes);
                let sendoff = combineDateTime('date_sendoff', 'time_sendoff', hasMinutes);

                if (wiro) body += `/ìœ„ë¡œ:${wiro}êµíšŒì¶œ`;
                if (ipgwan) body += `/ì…ê´€:${ipgwan}êµíšŒì¶œ`;
                if (sendoff) body += `/ì²œêµ­í™˜ì†¡:${sendoff}êµíšŒì¶œ`;
                fullText = `${header}${body}/${location}`;
            }

            let fullBytes = getByteLength(fullText);
            let resultHTML = "";

            if (mode === 'district') {
                if (fullBytes <= 90) {
                    resultHTML = createResultBoxHTML("ìƒì„± ê²°ê³¼", fullText, fullBytes, "normal", "res1");
                } else {
                    resultHTML += createResultBoxHTML("âš ï¸ ì›ë³¸ (LMS)", fullText, fullBytes, "warn", "res1");
                    let shortText = fullText.replace(/êµíšŒì¶œ/g, 'êµì¶œ');
                    if (getByteLength(shortText) > 90) {
                        shortText = shortText.replace(/ì†Œì²œ/g, '');
                    }
                    let shortBytes = getByteLength(shortText);
                    resultHTML += createResultBoxHTML("âœ¨ ì¶”ì²œ ë‹¨ì¶•ì•ˆ (" + (shortBytes <= 90 ? "SMS" : "LMS") + ")", shortText, shortBytes, "opt", "res2");
                }
            } else {
                resultHTML = createResultBoxHTML("ìƒì„± ê²°ê³¼", fullText, fullBytes, "normal", "res1");
            }

            resultHTML += `
            <div style="margin-top:20px; text-align:center;">
                <p style="font-size:13px; color:#888; margin-bottom:10px;">ğŸ‘‡ ì¶”ê°€ ì •ë³´ë¥¼ ë„£ì–´ êµìš°ì†Œì‹ì„ ì™„ì„±í•˜ì„¸ìš”</p>
                <button class="btn-add-secondary" onclick="startStep2()" style="border:1px solid var(--primary); color:var(--primary);">
                    <i class="ri-article-line"></i> êµìš°ì†Œì‹(ìƒì„¸) ì‘ì„±í•˜ê¸°
                </button>
            </div>
        `;

            resultArea.innerHTML = resultHTML;
            resultArea.style.display = 'block';
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        // --- Step 2 Logic (ì—¬ê¸°ëŠ” ê°€ë…ì„±ì„ ìœ„í•´ ê³µë°± ìœ ì§€ ê°€ëŠ¥) ---
        function startStep2() {
            const section = document.getElementById('step2-section');
            section.classList.remove('hidden');

            const mode = document.getElementById('mode').value;
            const mainDistrict = clean(document.getElementById('district').value).replace(/êµêµ¬/g, '');
            let mName = clean(document.getElementById('name1').value);
            let mTitle = document.getElementById('title1').value;
            let mSpouse = clean(document.getElementById('name2').value);
            let mSpouseTitle = document.getElementById('title2').value;
            let header = "";

            if (mode === 'district') {
                header = `[êµêµ¬ì¥-${mainDistrict}] ${buildPersonName(mName, mTitle, mSpouse, mSpouseTitle)} ${clean(document.getElementById('relation').value)} ì†Œì²œ`;
                copyDateTimeToStep2('date_wiro_district', 'time_wiro_district', 's2_date_wiro', 's2_time_wiro');
                document.getElementById('s2_chk_wiro').checked = true;
                document.getElementById('s2_chk_ip').checked = false;
                document.getElementById('s2_chk_bal').checked = false;
            } else {
                let names = `æ•…${mName}${mTitle}(${mSpouse}${mSpouseTitle})`;
                header = `[êµíšŒì¥-${mainDistrict}] ${names} ì†Œì²œ`;
                copyDateTimeToStep2('date_wiro_church', 'time_wiro_church', 's2_date_wiro', 's2_time_wiro');
                copyDateTimeToStep2('date_ipgwan', 'time_ipgwan', 's2_date_ip', 's2_time_ip');
                copyDateTimeToStep2('date_sendoff', 'time_sendoff', 's2_date_bal', 's2_time_bal');
                document.getElementById('s2_chk_wiro').checked = true;
                document.getElementById('s2_chk_ip').checked = true;
                document.getElementById('s2_chk_bal').checked = true;
            }
            document.getElementById('s2_header').value = header;
            document.getElementById('s2_binso').value = document.getElementById('location').value;
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function copyDateTimeToStep2(srcDateId, srcTimeId, tgtDateId, tgtTimeId) {
            const d = document.getElementById(srcDateId).value;
            const t = document.getElementById(srcTimeId).value;
            if (d) document.getElementById(tgtDateId).value = d;
            if (t) document.getElementById(tgtTimeId).value = t;
        }

        function getDayOfWeek(dateStr) {
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const date = new Date(dateStr);
            return days[date.getDay()];
        }

        function formatLongDate(dateStr) {
            if (!dateStr) return "";
            const [y, m, d] = dateStr.split('-');
            const day = getDayOfWeek(dateStr);
            return `${Number(m)}ì›” ${Number(d)}ì¼(${day})`;
        }

        // êµìš°ì†Œì‹ ìƒì„¸ ë²„ì „ìš© ì‹œê°„ í¬ë§· (í•œ ì¹¸ ê³µë°± í—ˆìš©)
        function formatTimeLong(text, forceMinutes = false) {
            const parsed = parseTime(text);
            if (!parsed.valid) return text || "";
            const { h, m, isPm } = parsed;
            const p = isPm ? "ì˜¤í›„" : "ì˜¤ì „";
            if (m === 0 && !forceMinutes) return `${p} ${h}ì‹œ`;
            else return `${p} ${h}:${String(m).padStart(2, '0')}`;
        }

        function generateStep2() {
            const header = document.getElementById('s2_header').value;
            const binso = document.getElementById('s2_binso').value;
            const jangji = document.getElementById('s2_jangji').value;

            let body = "";
            const wDate = document.getElementById('s2_date_wiro').value;
            const wRawTime = document.getElementById('s2_time_wiro').value;
            const wChurch = document.getElementById('s2_chk_wiro').checked ? " êµíšŒì¶œë°œ" : "";

            const iDate = document.getElementById('s2_date_ip').value;
            const iRawTime = document.getElementById('s2_time_ip').value;
            const iChurch = document.getElementById('s2_chk_ip').checked ? " êµíšŒì¶œë°œ" : "";

            const bDate = document.getElementById('s2_date_bal').value;
            const bRawTime = document.getElementById('s2_time_bal').value;
            const bChurch = document.getElementById('s2_chk_bal').checked ? " êµíšŒì¶œë°œ" : "";

            const rawTimes = [wRawTime, iRawTime, bRawTime];
            const hasMinutes = rawTimes.some(t => {
                const parsed = parseTime(t);
                return parsed.valid && parsed.m > 0;
            });

            if (wDate && wRawTime) body += `ìœ„ë¡œ: ${formatLongDate(wDate)} ${formatTimeLong(wRawTime, hasMinutes)}${wChurch}\n`;
            if (iDate && iRawTime) body += `ì…ê´€: ${formatLongDate(iDate)} ${formatTimeLong(iRawTime, hasMinutes)}${iChurch}\n`;

            const mode = document.getElementById('mode').value;
            const balLabel = (mode === 'church') ? "ì²œêµ­í™˜ì†¡" : "ë°œì¸";

            if (bDate && bRawTime) body += `${balLabel}: ${formatLongDate(bDate)} ${formatTimeLong(bRawTime, hasMinutes)}${bChurch}\n`;

            body += `ë¹ˆì†Œ: ${binso}\n`;
            if (jangji) body += `ì¥ì§€: ${jangji}`;

            const finalMsg = `${header}\n\n${body}`;
            const resBox = createResultBoxHTML("êµìš°ì†Œì‹ ì™„ì„±ë³¸", finalMsg, getByteLength(finalMsg), "normal", "res_step2");
            document.getElementById('step2-result').innerHTML = resBox;
            document.getElementById('step2-result').style.display = 'block';
        }
    </script>
</body>

</html>
