<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¥ë¡€ë¬¸ì ìƒì„±ê¸° (Premium)</title>

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Fonts -->
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Pretendard', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4f46e5', // Indigo 600
                        secondary: '#64748b', // Slate 500
                        accent: '#06b6d4', // Cyan 500
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col">

    <!-- Toast Container -->
    <div id="toast-container"
        class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50 flex flex-col gap-2 w-full max-w-sm px-4 pointer-events-none">
    </div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-200 shadow-sm">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                    <i class="ri-mail-send-line text-lg"></i>
                </div>
                <h1 class="font-bold text-lg text-slate-800">ì¥ë¡€ë¬¸ì ìƒì„±ê¸°</h1>
            </div>
            <!-- Mode Toggle (Desktop) -->
            <div class="hidden md:flex bg-slate-100 p-1 rounded-lg">
                <button onclick="App.setMode('district')" id="btn-mode-district"
                    class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-indigo-600 bg-white shadow-sm">êµêµ¬ì¥</button>
                <button onclick="App.setMode('church')" id="btn-mode-church"
                    class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700">êµíšŒì¥</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-5xl mx-auto w-full p-4 md:py-8 grid grid-cols-1 md:grid-cols-12 gap-6">

        <!-- Left Column: Input Form -->
        <div class="md:col-span-7 space-y-6">

            <!-- Mobile Mode Toggle -->
            <div class="md:hidden bg-white p-1 rounded-xl shadow-sm border border-slate-100 flex">
                <button onclick="App.setMode('district')" id="btn-mode-district-m"
                    class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all text-indigo-600 bg-indigo-50">êµêµ¬ì¥</button>
                <button onclick="App.setMode('church')" id="btn-mode-church-m"
                    class="flex-1 py-2.5 rounded-lg text-sm font-medium transition-all text-slate-500">êµíšŒì¥</button>
            </div>

            <!-- Card 1: Basic Info -->
            <section class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden slide-up">
                <div class="px-5 py-4 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                    <h2 class="font-bold text-slate-700 flex items-center gap-2">
                        <span
                            class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs">1</span>
                        ê¸°ë³¸ ì •ë³´
                    </h2>
                </div>
                <div class="p-5 space-y-4">
                    <!-- êµêµ¬ëª… & ì¥ì†Œ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5 ml-1">êµêµ¬ëª…</label>
                            <div class="relative">
                                <i class="ri-map-pin-user-line absolute left-3 top-3 text-slate-400"></i>
                                <input type="text" id="input-district" placeholder="ì˜ˆ: êµêµ¬"
                                    class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm font-medium"
                                    oninput="App.updateState('district', this.value)">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5 ml-1">ì¥ë¡€ì‹ì¥</label>
                            <div class="relative">
                                <i class="ri-hospital-line absolute left-3 top-3 text-slate-400"></i>
                                <input type="text" id="input-location" placeholder="ì˜ˆ: ì„œìš¸ì•„ì‚°ë³‘ì›"
                                    class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm font-medium"
                                    oninput="App.updateState('location', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- ê³ ì¸ ì •ë³´ -->
                    <div class="bg-indigo-50/30 rounded-xl p-4 border border-indigo-100/50">
                        <label class="block text-xs font-bold text-indigo-900 mb-2">ìƒì£¼ / ê³ ì¸ ì •ë³´ <span
                                class="text-indigo-400 font-normal text-[10px] ml-1">* 'æ•…' ìë™ ì¶”ê°€ë¨</span></label>
                        <div class="grid grid-cols-12 gap-2 mb-2">
                            <div class="col-span-8">
                                <input type="text" id="input-name" placeholder="ìƒì£¼ ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)"
                                    class="w-full px-3 py-2 bg-white border border-indigo-200 rounded-lg focus:outline-none focus:border-indigo-500 text-sm"
                                    oninput="App.updateState('deceased.name', this.value)">
                            </div>
                            <div class="col-span-4">
                                <select id="input-title"
                                    class="w-full px-2 py-2 bg-white border border-indigo-200 rounded-lg focus:outline-none focus:border-indigo-500 text-sm"
                                    onchange="App.updateState('deceased.title', this.value)">
                                    <option value="">ì§ë¶„</option>
                                    <option value="ì„±ë„">ì„±ë„</option>
                                    <option value="ì§‘ì‚¬">ì§‘ì‚¬</option>
                                    <option value="ì•ˆìˆ˜ì§‘ì‚¬">ì•ˆìˆ˜</option>
                                    <option value="ê¶Œì‚¬">ê¶Œì‚¬</option>
                                    <option value="ì¥ë¡œ">ì¥ë¡œ</option>
                                    <option value="ëª©ì‚¬">ëª©ì‚¬</option>
                                </select>
                            </div>
                        </div>
                        <!-- ë°°ìš°ì -->
                        <div class="grid grid-cols-12 gap-2 mb-2">
                            <div class="col-span-8">
                                <input type="text" id="input-spouse" placeholder="ë°°ìš°ì (ì—†ëŠ” ê²½ìš° ë¹ˆì¹¸)"
                                    class="w-full px-3 py-2 bg-white border border-indigo-200 rounded-lg focus:outline-none focus:border-indigo-500 text-sm"
                                    oninput="App.updateState('deceased.spouse', this.value)">
                            </div>
                            <div class="col-span-4">
                                <select id="input-spouse-title"
                                    class="w-full px-2 py-2 bg-white border border-indigo-200 rounded-lg focus:outline-none focus:border-indigo-500 text-sm"
                                    onchange="App.updateState('deceased.spouseTitle', this.value)">
                                    <option value="">ì§ë¶„</option>
                                    <option value="ì„±ë„">ì„±ë„</option>
                                    <option value="ì§‘ì‚¬">ì§‘ì‚¬</option>
                                    <option value="ì•ˆìˆ˜ì§‘ì‚¬">ì•ˆìˆ˜</option>
                                    <option value="ê¶Œì‚¬">ê¶Œì‚¬</option>
                                    <option value="ì¥ë¡œ">ì¥ë¡œ</option>
                                </select>
                            </div>
                        </div>
                        <!-- ê´€ê³„ (êµêµ¬ì¥ ëª¨ë“œ ì „ìš©) -->
                        <div id="wrapper-relation" class="mt-2">
                            <input type="text" id="input-relation" placeholder="ê´€ê³„ (ì˜ˆ: ë¶€ì¹œ, ëª¨ì¹œ, ì¥ì¸, ì‹œëª¨...)"
                                class="w-full px-3 py-2 bg-white border border-indigo-200 rounded-lg focus:outline-none focus:border-indigo-500 text-sm"
                                oninput="App.updateState('deceased.relation', this.value)">
                        </div>
                    </div>

                    <!-- Joint Funeral (Church Mode Only) -->
                    <div id="wrapper-joint" class="hidden">
                        <div id="joint-list" class="space-y-3 mb-3"></div>
                        <button onclick="App.addJoint()"
                            class="w-full py-3 border-2 border-dashed border-indigo-200 rounded-xl text-indigo-500 text-sm font-bold hover:bg-indigo-50 transition-colors flex items-center justify-center gap-2">
                            <i class="ri-add-circle-line text-lg"></i> ê²¹ì¥ ì¶”ê°€í•˜ê¸° (ë™ì‹œ ì¥ë¡€)
                        </button>
                    </div>

                </div>
            </section>

            <!-- Card 2: Schedule -->
            <section class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden slide-up"
                style="animation-delay: 0.1s;">
                <div class="px-5 py-4 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                    <h2 class="font-bold text-slate-700 flex items-center gap-2">
                        <span
                            class="w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs">2</span>
                        ì¥ë¡€ ì¼ì •
                    </h2>
                    <!-- Individual Toggle (District Mode Only) -->
                    <div id="wrapper-individual-toggle" class="flex items-center gap-2">
                        <span class="text-xs font-medium text-slate-500">ê°œë³„ ì¡°ë¬¸</span>
                        <div
                            class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="toggle-individual"
                                class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"
                                style="top: 2px; left: 2px; transition: all 0.3s;"
                                onclick="App.toggleIndividual(this.checked)" />
                            <label for="toggle-individual"
                                class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <style>
                        .toggle-checkbox:checked {
                            right: 0;
                            border-color: #10b981;
                        }

                        .toggle-checkbox:checked+.toggle-label {
                            background-color: #10b981;
                        }

                        .toggle-checkbox:checked {
                            transform: translateX(100%);
                        }
                    </style>
                </div>

                <div class="p-5 space-y-6">
                    <!-- Schedule Items -->
                    <div id="schedule-wiro" class="schedule-item"></div>
                    <div id="schedule-ipgwan" class="schedule-item hidden"></div>
                    <div id="schedule-balin" class="schedule-item"></div>
                </div>
            </section>

            <!-- Card 2.5: Details (Step 2 Data) -->
            <section class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden slide-up"
                style="animation-delay: 0.1s;">
                <div class="px-5 py-4 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center"
                    onclick="App.toggleDetails()" style="cursor: pointer">
                    <h2 class="font-bold text-slate-700 flex items-center gap-2">
                        <span
                            class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xs">3</span>
                        êµìš°ì†Œì‹ ìƒì„¸ ì •ë³´ (ì„ íƒ)
                    </h2>
                    <i id="icon-details-toggle"
                        class="ri-arrow-down-s-line text-slate-400 text-xl transition-transform"></i>
                </div>
                <div id="details-content" class="hidden p-5 space-y-4 bg-slate-50/30">
                    <p class="text-xs text-slate-500 mb-2">â€» ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ 'êµìš°ì†Œì‹' íƒ­ì— ìƒì„¸ ë‚´ìš©ì´ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</p>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1.5 ml-1">ì¥ì§€ (ì„ ì‚°/ë‚©ê³¨ë‹¹)</label>
                        <input type="text" id="input-jangji" placeholder="ì˜ˆ: ì‹œì•ˆê°€ì¡±ì¶”ëª¨ê³µì›"
                            class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl focus:outline-none focus:border-orange-400 text-sm"
                            oninput="App.updateState('jangji', this.value)">
                    </div>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer">
                            <input type="checkbox" id="chk-wiro-church" checked
                                class="w-4 h-4 text-orange-500 rounded focus:ring-orange-400"
                                onchange="App.updateState('churchDeparture.wiro', this.checked)">
                            <span>ìœ„ë¡œì˜ˆë°° êµíšŒì¶œë°œ</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer">
                            <input type="checkbox" id="chk-ipgwan-church" checked
                                class="w-4 h-4 text-orange-500 rounded focus:ring-orange-400"
                                onchange="App.updateState('churchDeparture.ipgwan', this.checked)">
                            <span>ì…ê´€ì˜ˆë°° êµíšŒì¶œë°œ</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer">
                            <input type="checkbox" id="chk-balin-church" checked
                                class="w-4 h-4 text-orange-500 rounded focus:ring-orange-400"
                                onchange="App.updateState('churchDeparture.balin', this.checked)">
                            <span>ë°œì¸ êµíšŒì¶œë°œ</span>
                        </label>
                    </div>
                </div>
            </section>

        </div>

        <!-- Right Column: Sticky Preview -->
        <div class="md:col-span-5 relative">
            <div class="sticky top-24 space-y-4">

                <!-- Preview Header -->
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-slate-600 text-sm">ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</h3>
                    <div class="flex gap-1" id="tab-preview">
                        <button onclick="App.setPreviewTab('simple')" id="btn-tab-simple"
                            class="px-3 py-1 text-xs font-bold rounded-full bg-indigo-100 text-indigo-700">ë¬¸ì
                            (ê¸°ë³¸)</button>
                        <button onclick="App.setPreviewTab('detail')" id="btn-tab-detail"
                            class="px-3 py-1 text-xs font-medium rounded-full text-slate-500 hover:bg-slate-100">êµìš°ì†Œì‹
                            (ìƒì„¸)</button>
                    </div>
                </div>

                <!-- Preview Box -->
                <div
                    class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-[500px] md:h-auto md:min-h-[400px]">
                    <!-- Message Header -->
                    <div class="bg-slate-100 px-4 py-3 border-b border-slate-200 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="w-2.5 h-2.5 bg-red-400 rounded-full"></span>
                            <span class="w-2.5 h-2.5 bg-yellow-400 rounded-full"></span>
                            <span class="w-2.5 h-2.5 bg-green-400 rounded-full"></span>
                        </div>
                        <span id="byte-counter" class="text-xs font-mono text-slate-400">0 Bytes</span>
                    </div>

                    <!-- Content -->
                    <div class="p-4 flex-grow bg-slate-50 relative overflow-hidden">
                        <div class="absolute inset-0 overflow-y-auto p-4 content-scrollbar custom-input outline-none whitespace-pre-wrap font-sans text-sm leading-relaxed text-slate-800"
                            id="preview-text" contenteditable="false"></div>
                    </div>

                    <!-- Actions -->
                    <div class="p-4 bg-white border-t border-slate-100 grid grid-cols-2 gap-3">
                        <button onclick="App.copyText()"
                            class="col-span-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-md shadow-indigo-200 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                            <i class="ri-file-copy-line"></i> í…ìŠ¤íŠ¸ ë³µì‚¬í•˜ê¸°
                        </button>
                    </div>
                </div>

                <p class="text-center text-xs text-slate-400">
                    Copyright Â© 2024 Funeral Messager. All rights reserved.
                </p>

            </div>
        </div>

    </main>

    <!-- Templates -->
    <template id="tmpl-schedule-row">
        <div class="grid grid-cols-12 gap-3 items-center">
            <div class="col-span-3 text-xs font-bold text-slate-500 text-right pr-2 label-name"></div>
            <div class="col-span-5 relative">
                <input type="date"
                    class="input-date w-full text-xs px-2 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500 font-sans"
                    required>
            </div>
            <div class="col-span-4 relative">
                <div class="flex bg-slate-50 border border-slate-200 rounded-lg overflow-hidden">
                    <select
                        class="input-ampm bg-transparent text-xs px-1 py-2 outline-none border-r border-slate-200 font-medium text-slate-600">
                        <option value="ì˜¤ì „">ì˜¤ì „</option>
                        <option value="ì˜¤í›„">ì˜¤í›„</option>
                    </select>
                    <input type="number" class="input-hour w-full text-center text-xs bg-transparent outline-none p-0"
                        placeholder="ì‹œ" min="1" max="12">
                    <span class="text-slate-300 py-2">:</span>
                    <input type="number" class="input-min w-full text-center text-xs bg-transparent outline-none p-0"
                        placeholder="ë¶„" min="0" max="59">
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- Single File Application Logic ---

        const Utils = {
            clean: (str) => str ? str.replace(/\s+/g, '') : '',
            getByteLength: (s) => {
                let b = 0;
                for (let i = 0; i < s.length; i++) {
                    const c = s.charCodeAt(i);
                    b += (c >> 7) ? 2 : 1;
                }
                return b;
            },
            formatDate: (dateStr) => {
                if (!dateStr) return "";
                const [y, m, d] = dateStr.split('-').map(Number);
                const target = new Date(y, m - 1, d);
                const today = new Date();
                target.setHours(0, 0, 0, 0); today.setHours(0, 0, 0, 0);
                const weekDays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                return (target.getTime() === today.getTime())
                    ? `${d}ì¼(ì˜¤ëŠ˜)`
                    : `${d}ì¼(${weekDays[target.getDay()]})`;
            },
            formatDateLong: (dateStr) => {
                if (!dateStr) return "";
                const [y, m, d] = dateStr.split('-').map(Number);
                const target = new Date(y, m - 1, d);
                const weekDays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                return `${m}ì›” ${d}ì¼(${weekDays[target.getDay()]})`;
            },
            pad: (n) => String(n).padStart(2, '0'),
            copyToClipboard: (text) => {
                if (!text) return;
                navigator.clipboard.writeText(text).then(() => {
                    App.showToast("í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ¨");
                }).catch(() => {
                    App.showToast("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢", true);
                });
            }
        };

        const App = {
            state: {
                mode: 'district', // 'district' | 'church'
                previewTab: 'simple', // 'simple' | 'detail'
                district: '',
                location: '',
                deceased: { name: '', title: '', spouse: '', spouseTitle: '', relation: '' },
                joints: [], // Array of { district, name, title, spouse, ... }
                isIndividual: false,
                jangji: '',
                churchDeparture: { wiro: true, ipgwan: true, balin: true },
                schedules: {
                    wiro: { date: '', ampm: 'ì˜¤ì „', hour: '', min: '' },
                    ipgwan: { date: '', ampm: 'ì˜¤ì „', hour: '', min: '' },
                    balin: { date: '', ampm: 'ì˜¤ì „', hour: '', min: '' },
                }
            },

            init() {
                // Set default dates to today
                const today = new Date().toISOString().split('T')[0];
                this.state.schedules.wiro.date = today;
                this.state.schedules.ipgwan.date = today;
                this.state.schedules.balin.date = today;

                this.renderScheduleInputs();
                this.render();
            },

            // --- State Actions ---
            setMode(mode) {
                this.state.mode = mode;
                // UI Toggle Logic
                document.getElementById('btn-mode-district').className = mode === 'district' ? "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-indigo-600 bg-white shadow-sm" : "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700";
                document.getElementById('btn-mode-church').className = mode === 'church' ? "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-indigo-600 bg-white shadow-sm" : "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700";

                // Mobile
                document.getElementById('btn-mode-district-m').className = mode === 'district' ? "flex-1 py-2.5 rounded-lg text-sm font-bold transition-all text-indigo-600 bg-indigo-50" : "flex-1 py-2.5 rounded-lg text-sm font-medium transition-all text-slate-500";
                document.getElementById('btn-mode-church-m').className = mode === 'church' ? "flex-1 py-2.5 rounded-lg text-sm font-bold transition-all text-indigo-600 bg-indigo-50" : "flex-1 py-2.5 rounded-lg text-sm font-medium transition-all text-slate-500";

                // Fields
                document.getElementById('wrapper-relation').style.display = mode === 'district' ? 'block' : 'none';
                document.getElementById('wrapper-joint').style.display = mode === 'church' ? 'block' : 'none';
                document.getElementById('wrapper-individual-toggle').style.display = mode === 'district' ? 'flex' : 'none';

                // Reset Individual toggle when switching modes
                if (mode === 'church') {
                    this.state.isIndividual = false;
                    document.getElementById('toggle-individual').checked = false;
                }

                this.renderScheduleInputs();
                this.render();
            },

            setPreviewTab(tab) {
                this.state.previewTab = tab;
                document.getElementById('btn-tab-simple').className = tab === 'simple' ? "px-3 py-1 text-xs font-bold rounded-full bg-indigo-100 text-indigo-700" : "px-3 py-1 text-xs font-medium rounded-full text-slate-500 hover:bg-slate-100";
                document.getElementById('btn-tab-detail').className = tab === 'detail' ? "px-3 py-1 text-xs font-bold rounded-full bg-indigo-100 text-indigo-700" : "px-3 py-1 text-xs font-medium rounded-full text-slate-500 hover:bg-slate-100";
                this.render();
            },

            updateState(path, value) {
                const parts = path.split('.');
                if (parts.length === 1) {
                    this.state[parts[0]] = value;
                } else {
                    this.state[parts[0]][parts[1]] = value;
                }
                this.render();
            },

            toggleIndividual(checked) {
                this.state.isIndividual = checked;
                this.renderScheduleInputs();
                this.render();
            },

            toggleDetails() {
                const el = document.getElementById('details-content');
                const icon = document.getElementById('icon-details-toggle');
                el.classList.toggle('hidden');
                icon.style.transform = el.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            },

            // --- Logic: Generator ---
            generateText() {
                const s = this.state;
                if (!s.district && !s.deceased.name) return "ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.";

                // 1. Header Construction
                let header = "";
                let body = "";

                const distName = Utils.clean(s.district).replace(/êµêµ¬/g, '');
                const mName = Utils.clean(s.deceased.name);
                const mTitle = s.deceased.title;
                const mSpouse = Utils.clean(s.deceased.spouse);
                const mSpouseTitle = s.deceased.spouseTitle;

                const buildName = (n, t, sn, st) => {
                    if (!n) return "";
                    if (!sn) return `${n}${t}`;
                    if (t === st) return `${n}(${sn})${t}`;
                    return `${n}${t}(${sn}${st})`;
                };

                if (s.mode === 'district') {
                    header = `[êµêµ¬ì¥-${distName}]`;
                    const rel = Utils.clean(s.deceased.relation).replace(/ì†Œì²œ/g, '');
                    const nameStr = buildName(mName, mTitle, mSpouse, mSpouseTitle);
                    body = `${nameStr}${rel}ì†Œì²œ`;
                } else {
                    // Church Mode
                    let headerText = `êµíšŒì¥-${distName}`;
                    const nameStr = buildName(`æ•…${mName}`, mTitle, mSpouse, mSpouseTitle);
                    body = `${nameStr}ì†Œì²œ`;

                    // Joint
                    s.joints.forEach(j => {
                        const jDist = Utils.clean(j.district).replace(/êµêµ¬/g, '');
                        const jName = Utils.clean(j.name);
                        if (jDist && jName) {
                            headerText += `/${j.type}-${jDist}`;
                            body += `/${buildName(jName, j.title, j.spouse, j.spouseTitle)}${Utils.clean(j.relation)}`;
                        }
                    });
                    header = `[${headerText}]`;
                }

                // 2. Schedule Logic
                const getTimeStr = (key, suffix = "") => {
                    const t = s.schedules[key];
                    if (!t.date || !t.hour) return "";
                    // Check if minutes exist
                    const min = parseInt(t.min) || 0;
                    const timePart = (min === 0) ? `${t.ampm}${t.hour}ì‹œ` : `${t.ampm}${t.hour}:${Utils.pad(min)}`; // Keep simple for LMS
                    return `${Utils.formatDate(t.date)}${timePart}${suffix}`;
                };

                if (s.mode === 'district') {
                    if (s.isIndividual) {
                        const balin = s.schedules.balin;
                        if (balin.date) body += `/ê°œë³„ì¡°ë¬¸/ë°œì¸:${Utils.formatDate(balin.date)}`;
                    } else {
                        const wiro = getTimeStr('wiro', 'êµíšŒì¶œ');
                        if (wiro) body += `/ìœ„ë¡œ:${wiro}`;
                    }
                } else {
                    const wiro = getTimeStr('wiro', 'êµíšŒì¶œ');
                    const ipgwan = getTimeStr('ipgwan', 'êµíšŒì¶œ');
                    const sendoff = getTimeStr('balin', 'êµíšŒì¶œ');
                    if (wiro) body += `/ìœ„ë¡œ:${wiro}`;
                    if (ipgwan) body += `/ì…ê´€:${ipgwan}`;
                    if (sendoff) body += `/ì²œêµ­í™˜ì†¡:${sendoff}`;
                }

                // 3. Location
                if (s.location) body += `/${Utils.clean(s.location)}`;

                return `${header}${body}`;
            },

            generateDetailText() {
                const s = this.state;
                if (!s.district && !s.deceased.name) return "ìƒì„¸ ì •ë³´ë¥¼ ë³´ì‹œë ¤ë©´ ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";

                const distName = Utils.clean(s.district).replace(/êµêµ¬/g, '');
                const mName = Utils.clean(s.deceased.name);
                const mTitle = s.deceased.title;
                const mSpouse = Utils.clean(s.deceased.spouse);
                const mSpouseTitle = s.deceased.spouseTitle;

                const buildName = (n, t, sn, st) => {
                    if (!n) return "";
                    if (!sn) return `${n}${t}`;
                    if (t === st) return `${n}(${sn})${t}`;
                    return `${n}${t}(${sn}${st})`;
                };

                let header = "";
                if (s.mode === 'district') {
                    header = `[êµêµ¬ì¥-${distName}] ${buildName(mName, mTitle, mSpouse, mSpouseTitle)} ${Utils.clean(s.deceased.relation)} ì†Œì²œ`;
                } else {
                    header = `[êµíšŒì¥-${distName}] æ•…${buildName(mName, mTitle, mSpouse, mSpouseTitle)} ì†Œì²œ`;
                }

                let body = "";

                const formatTimeLong = (t) => {
                    const min = parseInt(t.min) || 0;
                    return `${t.ampm} ${t.hour}:${Utils.pad(min)}`;
                };

                const getLine = (label, key, isChurchKey) => {
                    const t = s.schedules[key];
                    if (!t.date || !t.hour) return "";
                    const church = s.churchDeparture[isChurchKey] ? " (êµíšŒì¶œë°œ)" : "";
                    return `${label}: ${Utils.formatDateLong(t.date)} ${formatTimeLong(t)}${church}\n`;
                };

                body += getLine("ìœ„ë¡œ", "wiro", "wiro");
                body += getLine("ì…ê´€", "ipgwan", "ipgwan");

                const balinLabel = s.mode === 'church' ? "ì²œêµ­í™˜ì†¡" : "ë°œì¸";
                body += getLine(balinLabel, "balin", "balin");

                if (s.location) body += `ë¹ˆì†Œ: ${s.location}\n`;
                if (s.jangji) body += `ì¥ì§€: ${s.jangji}`;

                return `${header}\n\n${body}`;
            },

            // --- Render Logic ---
            renderScheduleInputs() {
                const containerWiro = document.getElementById('schedule-wiro');
                const containerIpgwan = document.getElementById('schedule-ipgwan');
                const containerBalin = document.getElementById('schedule-balin');

                // Clear
                containerWiro.innerHTML = '';
                containerIpgwan.innerHTML = '';
                containerBalin.innerHTML = '';

                // Helper to create row
                const createRow = (label, key) => {
                    const tmpl = document.getElementById('tmpl-schedule-row').content.cloneNode(true);
                    tmpl.querySelector('.label-name').textContent = label;

                    const dateInput = tmpl.querySelector('.input-date');
                    dateInput.value = this.state.schedules[key].date;
                    dateInput.onchange = (e) => { this.state.schedules[key].date = e.target.value; this.render(); };

                    const ampmInput = tmpl.querySelector('.input-ampm');
                    ampmInput.value = this.state.schedules[key].ampm;
                    ampmInput.onchange = (e) => { this.state.schedules[key].ampm = e.target.value; this.render(); };

                    const hourInput = tmpl.querySelector('.input-hour');
                    hourInput.value = this.state.schedules[key].hour;
                    hourInput.oninput = (e) => { this.state.schedules[key].hour = e.target.value; this.render(); };

                    const minInput = tmpl.querySelector('.input-min');
                    minInput.value = this.state.schedules[key].min;
                    minInput.oninput = (e) => { this.state.schedules[key].min = e.target.value; this.render(); };

                    return tmpl;
                };

                if (this.state.mode === 'district') {
                    if (this.state.isIndividual) {
                        // Only Balin Date for Individual
                        const balinRow = createRow('ë°œì¸', 'balin');
                        // Hide time inputs for individual balin if needed, based on original logic "ì‹œê°„ ì…ë ¥ ì—†ìŒ"
                        // BUT original code had `date_balin` only. Let's hide time part.
                        balinRow.querySelector('.col-span-4').style.visibility = 'hidden';
                        containerBalin.appendChild(balinRow);
                    } else {
                        containerWiro.appendChild(createRow('ìœ„ë¡œì˜ˆë°°', 'wiro'));
                    }
                    containerIpgwan.classList.add('hidden');
                } else {
                    // Church Mode
                    containerWiro.appendChild(createRow('ìœ„ë¡œì˜ˆë°°', 'wiro'));
                    containerIpgwan.appendChild(createRow('ì…ê´€ì˜ˆë°°', 'ipgwan'));
                    containerIpgwan.classList.remove('hidden');
                    containerBalin.appendChild(createRow('ì²œêµ­í™˜ì†¡', 'balin'));
                }
            },

            addJoint() {
                this.state.joints.push({ type: 'êµêµ¬ì¥', district: '', name: '', title: '', spouse: '', spouseTitle: '', relation: '' });
                this.renderJoints();
                this.render();
            },

            removeJoint(index) {
                this.state.joints.splice(index, 1);
                this.renderJoints();
                this.render();
            },

            renderJoints() {
                const list = document.getElementById('joint-list');
                list.innerHTML = '';
                this.state.joints.forEach((j, idx) => {
                    const el = document.createElement('div');
                    el.className = 'bg-slate-50 p-3 rounded-lg border border-slate-200 relative';
                    el.innerHTML = `
                        <div class="flex justify-between mb-2">
                            <span class="text-xs font-bold text-indigo-500">ì¶”ê°€ ì¥ë¡€ ${idx + 1}</span>
                            <button onclick="App.removeJoint(${idx})" class="text-xs text-red-400 hover:text-red-500">ì‚­ì œ</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <select onchange="App.state.joints[${idx}].type = this.value; App.render()" class="bg-white border border-slate-200 rounded p-1 text-xs">
                                <option value="êµêµ¬ì¥" ${j.type === 'êµêµ¬ì¥' ? 'selected' : ''}>êµêµ¬ì¥</option>
                                <option value="êµíšŒì¥" ${j.type === 'êµíšŒì¥' ? 'selected' : ''}>êµíšŒì¥</option>
                            </select>
                            <input oninput="App.state.joints[${idx}].district = this.value; App.render()" value="${j.district}" placeholder="êµêµ¬ëª…" class="bg-white border border-slate-200 rounded p-1 text-xs">
                        </div>
                         <div class="grid grid-cols-12 gap-1 mb-2">
                            <input oninput="App.state.joints[${idx}].name = this.value; App.render()" value="${j.name}" placeholder="ì´ë¦„" class="col-span-8 bg-white border border-slate-200 rounded p-1 text-xs">
                             <select onchange="App.state.joints[${idx}].title = this.value; App.render()" class="col-span-4 bg-white border border-slate-200 rounded p-1 text-xs">
                                <option value="">ì§ë¶„</option>
                                <option value="ì„±ë„" ${j.title === 'ì„±ë„' ? 'selected' : ''}>ì„±ë„</option>
                                <option value="ì§‘ì‚¬" ${j.title === 'ì§‘ì‚¬' ? 'selected' : ''}>ì§‘ì‚¬</option>
                                <option value="ê¶Œì‚¬" ${j.title === 'ê¶Œì‚¬' ? 'selected' : ''}>ê¶Œì‚¬</option>
                                <option value="ì¥ë¡œ" ${j.title === 'ì¥ë¡œ' ? 'selected' : ''}>ì¥ë¡œ</option>
                            </select>
                        </div>
                         <div class="grid grid-cols-12 gap-1 mb-2">
                            <input oninput="App.state.joints[${idx}].spouse = this.value; App.render()" value="${j.spouse}" placeholder="ë°°ìš°ì" class="col-span-8 bg-white border border-slate-200 rounded p-1 text-xs">
                             <select onchange="App.state.joints[${idx}].spouseTitle = this.value; App.render()" class="col-span-4 bg-white border border-slate-200 rounded p-1 text-xs">
                                <option value="">ì§ë¶„</option>
                                <option value="ì„±ë„">ì„±ë„</option>
                                <option value="ê¶Œì‚¬">ê¶Œì‚¬</option>
                                <option value="ì¥ë¡œ">ì¥ë¡œ</option>
                            </select>
                        </div>
                        <input oninput="App.state.joints[${idx}].relation = this.value; App.render()" value="${j.relation}" placeholder="ê´€ê³„" class="w-full bg-white border border-slate-200 rounded p-1 text-xs">
                    `;
                    list.appendChild(el);
                });
            },

            render() {
                // Determine text based on tab
                let text = "";
                if (this.state.previewTab === 'simple') {
                    text = this.generateText();
                } else {
                    text = this.generateDetailText();
                }

                // Update Preview Box
                const previewEl = document.getElementById('preview-text');
                previewEl.innerText = text;

                // Update Byte Count
                const bytes = Utils.getByteLength(text);
                const badgeClass = bytes <= 90 ? "text-green-600 bg-green-100" : "text-amber-600 bg-amber-100";
                const badgeLabel = bytes <= 90 ? "SMS" : "LMS";

                document.getElementById('byte-counter').innerHTML = `
                    <span class="font-bold text-slate-700">${bytes}</span> Bytes 
                    <span class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold ${badgeClass}">${badgeLabel}</span>
                `;
            },

            copyText() {
                const text = document.getElementById('preview-text').innerText;
                if (!text) {
                    this.showToast("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.", true);
                    return;
                }
                Utils.copyToClipboard(text);
            },

            showToast(msg, isError = false) {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const bgClass = isError ? 'bg-red-500' : 'bg-slate-800';

                el.className = `${bgClass} text-white text-sm font-medium px-4 py-3 rounded-xl shadow-lg shadow-black/10 flex items-center gap-2 transform translate-y-5 opacity-0 transition-all duration-300`;
                el.innerHTML = `
                    <i class="${isError ? 'ri-error-warning-fill' : 'ri-checkbox-circle-fill'} text-lg"></i>
                    <span>${msg}</span>
                `;

                container.appendChild(el);

                // Animate In
                setTimeout(() => { el.classList.remove('translate-y-5', 'opacity-0'); }, 10);

                // Animate Out
                setTimeout(() => {
                    el.classList.add('opacity-0', '-translate-y-2');
                    setTimeout(() => el.remove(), 300);
                }, 2000);
            }
        };

        // Initialize
        window.onload = () => App.init();

    </script>
</body>

</html>